version: 2.1

jobs:
  build-arm-docker:
    # ä½¿ç”¨ Machine Executor (è™šæ‹Ÿæœºæ¨¡å¼)ï¼Œè€Œä¸æ˜¯ Docker å®¹å™¨æ¨¡å¼
    # è¿™æ ·å¯ä»¥è·å¾—å®Œæ•´çš„ç³»ç»Ÿæƒé™ï¼Œæ–¹ä¾¿è¿è¡Œ Docker å¼•æ“
    machine:
      image: ubuntu-2204:current
    
    # ğŸŒŸ å…³é”®ç‚¹ï¼šæŒ‡å®šä½¿ç”¨åŸç”Ÿ ARM èµ„æº
    # arm.medium æ˜¯ CircleCI æä¾›çš„æ ‡å‡† ARM å®ä¾‹
    resource_class: arm.medium

    steps:
      - checkout

      # 1. éªŒè¯ä¸€ä¸‹æ˜¯ä¸æ˜¯çœŸçš„ ARM æœºå™¨ (å¯é€‰)
      - run:
          name: "Verify Architecture"
          command: |
            echo "å½“å‰æ¶æ„æ˜¯ï¼š"
            uname -m
            # å¦‚æœè¾“å‡º aarch64ï¼Œè¯´æ˜æ˜¯åŸç”Ÿ ARM

      # 2. æ„å»º Docker é•œåƒ
      - run:
          name: "Build Docker Image"
          command: |
            # å‡è®¾ä½ çš„ Dockerfile åœ¨æ ¹ç›®å½•
            docker build -t my-app:arm64 .
            
            # éªŒè¯é•œåƒæ¶æ„
            docker inspect my-app:arm64 | grep Architecture

      # 3. (å¯é€‰) æ¨é€åˆ° Docker Hub / é˜¿é‡Œäº‘
      # éœ€è¦åœ¨ CircleCI é¡¹ç›®è®¾ç½®é‡Œé…ç½®ç¯å¢ƒå˜é‡ DOCKER_USER å’Œ DOCKER_PASS
      - run:
          name: "Push to Docker Hub"
          command: |
            echo "$DOCKER_PASS" | docker login -u "$DOCKER_USER" --password-stdin
            docker push nodejs2ago:arm64

workflows:
  build-workflow:
    jobs:
      - build-arm-docker